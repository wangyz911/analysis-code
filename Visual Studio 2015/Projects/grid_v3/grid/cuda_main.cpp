#include "cuda_runtime.h"
#include "device_launch_parameters.h"
#include <conio.h>
#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <string.h>  // 用来复制数组
#include "device_functions.h"

void cuda_QI(float *p_img, int arraySize, int n_stream, float *rdp_profile, float *xc, float *yc);

void cuda_QI2(float *p_img, int arraySize, int n_stream, float *rdp_profile, float *xc, float *yc);
void cuda_QI3(float *p_img, int arraySize, int n_stream, float *rdp_profile, float *xc, float *yc);
void cuda_QI4(float *p_img_4d, int arraySize, int n_frame, int n_stream, float *rdp_profile, float *xc, float *yc);

int main(void)
{
	//_CrtSetBreakAlloc(72); //98500为上面内存泄漏的块号.
	int arraySize = 50;
	int LEN = arraySize*arraySize;
	size_t img_bytes = arraySize*arraySize * sizeof(float);   // 矩阵元素所占空间
	size_t f_bytes = sizeof(float);

	int n_stream =4;
	int n_frame = 5;
	float r_step = 0.4;
	int r_max = arraySize / 2 - 5;
	int r_N = r_max / r_step;
	size_t r_bytes = r_N * sizeof(float);
	//float *p_img = (float*)malloc(img_bytes*n_stream);
	float *p_img = (float *)malloc(n_frame*LEN*sizeof(float));
	float *p_img_4d=(float *)malloc(n_stream*n_frame*LEN*sizeof(float));
	float img_mat[50][50] = {
		109,107,107,108,103,103,105,105,111,106,110,112,108,110,110,111,113,117,110,118,113,116,111,112,117,117,118,116,115,116,113,117,118,119,116,122,114,116,121,116,116,119,112,108,116,111,112,102,117,105,
		106,109,110,103,110,105,108,105,113,109,110,113,109,108,113,114,112,110,103,114,117,114,112,114,107,118,125,115,121,117,111,117,120,116,120,114,113,116,115,120,113,112,110,115,115,116,115,113,112,110,
		111,108,111,109,110,107,106,110,103,113,108,112,109,103,106,111,114,110,116,116,113,117,115,111,116,116,118,122,117,113,114,119,105,115,120,118,116,116,119,118,114,116,116,114,106,112,109,109,108,110,
		109,107,104,110,108,110,113,111,109,104,112,112,111,107,108,107,116,115,116,114,113,117,111,113,112,116,117,116,116,114,116,120,112,116,115,118,116,116,112,116,115,111,110,111,110,116,111,105,108,114,
		109,105,110,113,114,117,110,111,108,107,109,112,112,107,112,120,109,115,116,113,114,110,116,120,113,120,115,119,116,117,110,115,109,117,119,116,117,120,114,113,115,116,115,113,110,108,110,107,108,105,
		99,105,111,105,107,110,112,106,110,108,114,110,105,101,109,110,112,107,114,111,109,111,112,112,113,113,106,111,111,115,113,117,112,115,112,116,114,112,111,112,117,114,117,116,112,110,109,105,108,106,
		100,101,110,109,110,108,108,107,107,110,107,105,108,107,112,110,106,110,109,110,116,122,112,113,115,118,116,117,111,113,112,112,115,114,116,115,116,121,113,118,115,113,111,110,111,115,112,111,106,105,
		103,104,111,109,114,105,106,105,109,109,106,107,110,103,110,106,109,112,114,112,113,110,112,110,116,110,111,112,119,116,112,115,115,112,110,111,112,121,112,117,112,118,113,112,109,116,112,109,108,110,
		102,103,109,102,104,108,111,110,110,102,107,105,110,107,114,105,102,106,109,110,116,110,116,120,122,119,115,116,113,110,109,114,121,114,108,111,122,116,115,120,115,115,114,111,115,116,109,107,109,107,
		108,109,110,112,106,105,110,111,108,107,113,111,114,112,112,100,106,112,118,110,114,116,111,109,113,113,113,112,107,116,115,111,111,121,114,118,116,114,115,119,116,118,115,116,111,108,106,110,108,109,
		109,103,111,106,108,110,102,101,103,105,100,107,113,107,111,109,112,108,108,108,111,112,108,112,111,114,115,114,113,103,120,120,113,112,119,119,116,115,116,117,117,119,111,112,112,106,111,111,108,109,
		109,109,114,109,111,104,103,107,105, 98,109,114,111,110,113,109,106,112,113,116,113,114,108,115,112,115,117,114,118,115,112,114,117,119,118,118,123,120,116,111,115,118,115,112,114,117,110,116,115,112,
		114,116,108,105,112,112,109,110,107,109,110,111,117,113,111,113,120,116,115,105,107,110,115,105,112,117,107,109,113,118,118,114,111,115,117,115,120,122,117,119,123,109,119,116,111,117,113,116,111,105,
		108,114,105,111,105,115,108,104,109,107,109,108,117,109,111,122,116,108,114,111,114,118,121,125,122,122,123,118,117,116,117,119,119,112,118,114,116,115,118,114,118,111,113,113,115,110,116,115,115,110,
		113,110,110,109,110,106,101,106,106,103,109,110,102,114,117,114,114,112,119,115,113,119,119,123,122,120,123,124,125,124,119,111,116,119,114,116,124,118,106,119,114,116,118,115,117,109,109,111,111,111,
		109,109,107,106,110,107,106,111,107,111,111,112,115,117,112,114,118,123,115,108,117,101, 96, 96,103,106,109,123,125,123,129,123,108,121,123,120,117,120,114,118,116,112,106,112,111,116,116,111,114,113,
		111,109,106,107,110,100,106,105,104,107,108,116,118,111,118,117,121,109, 98, 91, 85, 86, 95,100, 91, 92, 80, 93,105,118,127,128,118,114,120,120,112,121,115,112,118,112,111,107,111,110,116,113,112,108,
		117,108,113,110,106,109,106,106,107,106,112,109,109,112,114,113,101, 90, 94,115,144,156,170,171,172,159,132,105, 83, 88,108,117,131,123,109,119,117,115,116,115,116,118,111,118,116,114,112,113,104,106,
		111,112,108,104,103,108,102,103,108,103,111,112,110,116,106, 93, 88,104,143,183,192,192,188,191,194,193,193,178,148,103, 88,105,118,127,120,115,119,116,112,114,115,114,107,111,115,109,112,111,106,112,
		109,106,111,106,111,110,104,106,111,107,107,108,120,117, 91, 87,121,168,191,184,160,141,130,118,128,151,166,191,199,171,122, 88, 97,121,119,114,113,114,113,121,108,115,114,114,112,116,108,109,111,110,
		106,107,103,106,110,103,104,105,105,113,102,106,117, 90, 86,122,178,189,169,123, 72, 52, 39, 33, 46, 59, 87,136,178,202,175,116, 84,106,124,118,110,116,115,116,115,110,115,115,114,111,108,105,109,110,
		112,109,111,106,104,100,102,105,107,102,107,115,108, 83,111,164,193,152, 90, 37, 13, 21, 20, 18, 24, 31, 40, 67,120,176,199,174, 99, 88,114,123,112,112,115,114,116,112,119,114,115,115,105,106,105,110,
		112,102,105,106,109,102,111,102, 97,106,112,119, 90, 83,146,192,170, 82, 31, 18, 10, 10, 22, 20, 26,  8, 23, 44, 72,118,184,197,148, 93, 98,126,121,116,115,114,117,114,111,114,112,102,111,110,108,103,
		114,105,103,106,111,102,106,109,111,107,117,107, 79,112,175,189,109, 38, 19,  4, 27, 54, 44, 48, 47, 43, 16, 15, 44, 76,143,204,179,100, 81,121,119,117,112,119,118,115,123,114,113,111,111,105,112,108,
		105,107,110,102,108,102,103,106,106,101,122,100, 76,131,187,164, 60, 23,  1, 17, 64, 52, 53, 68, 51, 29, 46, 11, 21, 63,114,192,193,130, 85,116,123,108,111,114,119,120,116,115,116,110,109,113,106,104,
		109,110,104,107,112,112,104,103,107,109,125, 96, 79,143,186,143, 43, 21,  4, 47, 62, 48,113,153,119, 51, 45, 38, 19, 57, 90,172,200,148, 77,106,130,108,112,111,122,121,118,113,109,110,108,115,105,112,
		107,109,111,105,102,108,110,108,107,108,115, 93, 82,157,189,123, 38, 10,  7, 59, 45, 78,136,133,109, 66, 37, 43,  7, 48, 84,166,201,153, 80,105,130,115,115,115,126,118,113,117,116,121,113,112,104,113,
		111,112,105,110,108,109,108,107,105,110,121, 94, 78,151,191,130, 36, 18, 11, 59, 44, 70,145,154,120, 68, 35, 48, 11, 52, 87,161,203,156, 84,103,128,112,114,109,121,123,120,126,111,110,115,113,112,109,
		110,109,110,103,107,111,109,108,109,105,116,103, 81,145,193,147, 49, 21,  3, 48, 63, 54,103,143,100, 38, 48, 39, 17, 49, 95,172,200,148, 86,110,128,110,112,120,119,114,113,120,113,114,113,111,110,112,
		110,111,104,104,112,112,110,110,112,107,116,109, 78,119,188,176, 76, 29, 11, 18, 59, 62, 47, 57, 47, 38, 47, 19, 23, 58,110,194,194,127, 85,123,128,109,115,114,119,118,122,115,119,115,111,118,116,112,
		108,108,111,105,111,112,109,110,111,103,113,110, 76, 94,165,187,126, 43, 21, 10, 20, 44, 61, 54, 53, 43, 23, 16, 50, 78,149,206,173,108, 87,125,116,119,115,112,118,116,115,108,112,111,118,111,115,109,
		108,107,118,107,106,112,114,111,108,106,112,119, 93, 75,136,182,176, 91, 35, 20, 10, 12, 13, 22, 18, 12, 23, 36, 68,121,193,200,140, 85,104,132,124,114,118,115,122,112,114,112,108,113,113,112,115,112,
		113,110,116,107,108,106,111,116,107,112,106,112,108, 75,100,150,182,160, 95, 47, 24, 19, 14, 16, 21, 26, 38, 68,122,177,201,165, 99, 85,119,132,110,119,117,118,115,108,119,107,115,114,115,110,108,118,
		116,109,113,110,112,112,114,114,108,110,110,115,118, 89, 75,106,161,189,172,125, 79, 51, 45, 44, 53, 61,100,143,177,197,172,112, 83,108,119,115,105,120,112,116,117,114,113,112,113,109,111,112,112,116,
		113,111,110,112,115,115,114,120,116,106,110,104,112,112, 87, 77,111,151,186,189,172,148,130,138,142,159,181,193,197,166,112, 86, 99,118,129,111,115,119,112,113,115,112,116,116,111,107,118,114,114,119,
		109,112,117,114,117,117,108,111,115,109,107,105,102,117,114, 88, 78, 98,133,167,191,194,195,199,197,193,192,175,136, 93, 81, 94,121,128,114,112,119,117,120,118,113,112,112,116,111,114,112,113,112,119,
		112,117,111,114,114,114,118,111,110,113,112,112,102,109,115,114, 90, 80, 85, 98,123,143,154,164,155,146,124,101, 82, 88, 98,116,126,122,110,123,111,120,120,118,114,109,111,114,118,117,117,108,113,110,
		111,109,110,122,114,109,113,106,112,109,106,107,109,103,106,115,110,104, 93, 85, 81, 87, 89, 94, 92, 85, 82, 90, 98,105,119,129,119,114,120,118,117,121,117,111,119,113,120,118,112,114,120,117,120,112,
		111,115,113,116,120,115,109,109,114,116,105,110,113,109,108,108,107,119,109,110,107,106,100, 93, 98,100,109,105,116,120,121,115,110,118,120,114,120,121,118,116,109,116,119,117,120,118,115,119,119,122,
		111,109,111,114,111,113,109,113,109,103,106,112,109,107,112,107,105,105,107,120,112,112,108,109,115,113,116,118,116,112,111,111,121,123,116,115,120,114,119,123,115,108,118,115,120,121,121,125,118,117,
		115,111,102,110,113,118,107,115,114,105,108,111,108,104,107,113,106,105,106,108,111,111,115,115,116,117,116,112,104,110,113,123,119,119,124,119,116,124,122,112,118,114,113,115,119,115,119,117,118,118,
		113,118,109,112,113,112,109,115,112,108,111,108,105,109,105,103, 99,105,105,113,108,106,106,108,102,114,109,107,113,116,116,116,113,118,118,114,117,123,117,116,112,114,120,108,116,121,118,117,118,121,
		115,114,113,115,120,111,110,116,113,108,112,107,108,102,115,114,106,106,109,108,112,112,112,103,118,112,122,119,112,114,116,112,117,116,115,115,121,121,115,117,119,119,120,117,117,119,126,120,122,120,
		114,120,119,113,112,119,109,112,116,110,101,106,109,107,109,105,108,107,110,106,106,109,113,106,112,106,111,109,107,114,119,107,110,115,116,123,117,115,121,110,113,120,112,113,118,118,118,124,118,116,
		114,112,115,117,116,116,111,109,110,106,109,108,103,108,109,108,106,105,113,111,114,109,109,112,111,110,111,114,112,112,112,110,114,109,114,118,117,120,112,115,116,114,110,112,117,116,114,117,122,121,
		118,112,113,115,114,111,113,111,106,107,117,106,108,114,107,108,110,107,102,107,109,107,107,107,110,109,108,104,111,111,115,114,116,117,116,118,117,119,117,119,113,113,114,113,114,116,115,119,117,122,
		109,114,114,113,110,113,113,107,112,105,109,110,106,110,106,109,106,109,110,117,114,111,108,103,110,108,110,106,112,118,118,112,112,115,115,113,113,111,119,114,114,114,119,120,120,115,112,115,119,120,
		110,116,114,112,115,115,110,113,115,107,112,108,111,110,112,110,109,106,103,108,111,110,111,110,109,105,107,110,105,108,112,108,110,116,111,113,111,119,122,113,112,119,113,123,112,113,117,114,112,122,
		112,114,112,116,118,108,112,106,111,108,109,102,114,109,109,107,108,112,115,107,109,108,109,106,102,106,107,113,109,115,113,109,110,114,113,114,115,116,118,114,119,117,115,112,113,117,115,115,118,116,
		117,115,118,115,115,111,111,109,110,109,106,113,105,109,109,108,105,105,105,115,108,114,112,110,110,114,110,110,110,110,114,117,112,117,114,115,114,113,116,118,118,114,120,121,114,120,121,113,112,115


	};

	//// setting cache and shared modes
	//cudaDeviceSetCacheConfig(cudaFuncCachePreferL1);
	//cudaDeviceSetSharedMemConfig(cudaSharedMemBankSizeFourByte);


	
	for (int i = 0; i < n_frame; i++)
	{
		int offset = i*LEN;
         memcpy(p_img+offset,img_mat,img_bytes);
	}

	// 构造四维矩阵，维度分别表示ROI数，单个ROI的帧数，以及图像的长宽
	for (int i = 0; i < n_stream; i++)
	{
		int s_offset = i*LEN*n_frame;
		memcpy(p_img_4d + s_offset, p_img, img_bytes*n_frame);
	}

	float * rdp_profile = (float *)malloc(r_bytes*n_stream);

	float *yc = (float*)malloc(f_bytes*n_stream);

	float *xc = (float*)malloc(f_bytes*n_stream);

	float * rdp_profile_4d = (float *)malloc(r_bytes*n_frame*n_stream);
	float * yc_4d = (float *)malloc(f_bytes*n_frame*n_stream);
	float * xc_4d = (float *)malloc(f_bytes*n_frame*n_stream);




	//cuda_QI(p_img, arraySize, n_stream, rdp_profile,xc, yc);

	 //cuda_QI3(p_img, arraySize, n_stream, rdp_profile, xc, yc);
	for (int i = 0; i < 1; i++)
	{
		cuda_QI4(p_img_4d, arraySize, n_frame, n_stream, rdp_profile_4d, xc_4d, yc_4d);
}



	 free(rdp_profile_4d);
	 rdp_profile_4d = NULL;
	 free(yc_4d);
	 yc_4d = NULL;
	 free(xc_4d);
	 xc_4d = NULL;
	 free(p_img);
	 p_img = NULL;
	 free(p_img_4d);
	 p_img_4d = NULL;

	free(rdp_profile);
	rdp_profile = NULL;
	free(yc);
	yc = NULL;
	free(xc);
	xc = NULL;
	//printf("good to end!");
	return 0;
}
